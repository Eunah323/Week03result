<!doctype html>
<html lang="en">

<head>
    <script src="https://kit.fontawesome.com/be78360a92.js" crossorigin="anonymous"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
            crossorigin="anonymous"></script>

    <title>ëª¨ë‘ì˜ ì¼ê¸°</title>

    <style>
        .mytitle {
            width: 100%;
            height: 250px;

            background-image: linear-gradient(0deg, rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('https://images.unsplash.com/photo-1528938102132-4a9276b8e320?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=2070&q=80');
            background-position: center;
            background-size: cover;

            color: white;

            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .mytitle > button {
            width: 200px;
            height: 50px;

            background-color: transparent;
            color: white;

            border-radius: 50px;
            border: 1px solid white;

            margin-top: 10px;
        }

        .mytitle > button:hover {
            border: 2px solid white;
        }

        .mycomment {
            color: grey;
        }

        .wrap {
            width: 1200px;
            width: 95%;
            margin: 20px auto 0 auto;
        }

        .mypost {
            border-radius: 10px;
            border: 1px solid white;
            max-width: 500px;
            width: 95%;
            height: 350px;
            margin: 10px auto 0 auto;
            padding: 20px;
            box-shadow: 0px 0px 3px 0px grey;
            display: none;
        }
    </style>
    <script>
        $(document).ready(function () {
            listing();
        });

        //ëœë¤ì˜ ìœ ì €ë„¤ì„ ë§Œë“¤ê¸°
        function genRandomName(length) {
            let result = '';
            let characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let charactersLength = characters.length;
            for (let i = 0; i < length; i++) {
                let number = Math.random() * charactersLength;
                let index = Math.floor(number);
                result += characters.charAt(index);
            }
            return result;
        }
        function listing() {
            $('#diary-box').empty()
            $.ajax({
                type: "GET",
                url: "/api/diaries",
                data: {},
                success: function (response) {
                    for (i = 0; i < response.length; i++) {
                        let rows = response[i];
                        let id = rows['id'];
                        let title = rows['title'];
                        let nickname = rows['nickname'];
                        let username = rows['username'];
                        let contents = rows['contents'];
                        let modifiedAt = rows['modifiedAt'];

                        addHTML(id, title, nickname, username, contents, modifiedAt);


                    }
                }
            })
            console.log('í™”ë©´ ë¡œë”© í›„ ì˜ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤');
        }
        function modifying(id) {
            // 1. ì‘ì„± ëŒ€ìƒ ë©”ëª¨ì˜ usernameê³¼ contents ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
            let username = $(`#${id}-username`).text();
            let nickname = $(`#${id}-nickname`).val();
            let title = $(`#${id}-title`).val();
            let contents = $(`#${id}-contents`).val();
            // 2. ì‘ì„±í•œ ë©”ëª¨ê°€ ì˜¬ë°”ë¥¸ì§€ isValidContents í•¨ìˆ˜ë¥¼ í†µí•´ í™•ì¸í•©ë‹ˆë‹¤.
            // 3. ì „ë‹¬í•  data JSONìœ¼ë¡œ ë§Œë“­ë‹ˆë‹¤.
            let data = {'title':title, 'username': username, 'nickname': nickname, 'contents': contents};
            // 4. PUT /api/memos/{id} ì— dataë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤.
            $.ajax({
                type: "PUT",
                url: `/api/diaries/${id}`,
                contentType: "application/json",
                data: JSON.stringify(data),
                success: function (response) {
                    alert('ì¼ê¸° ë³€ê²½ì— ì„±ê³µí•˜ì˜€ìŠµë‹ˆë‹¤.');
                    window.location.reload();
                }
            });
            console.log(username,nickname,title,contents);
        }
        function deleting(id) {
            $.ajax({
                type: "DELETE",
                url: `/api/diaries/${id}`,
                success: function (response) {
                    alert('ë©”ì‹œì§€ ì‚­ì œì— ì„±ê³µí•˜ì˜€ìŠµë‹ˆë‹¤.');
                    window.location.reload();
                }
            })

        }
        function addHTML (id, title, nickname, username, contents, modifiedAt){

            let temp_html = `
        <div class="col">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="diary-num" id="${id}">No.${id}</h5>
                    <p class="mycomment" ${id}-username>ê³ ìœ ë²ˆí˜¸ : ${username}</p>
                    <p onclick="location.href='/detail.html?${id}'" id="${id}-title">ì œëª© : ${title}ğŸ‘ˆëˆ„ë¥´ì„¸ìš”~!</p>
                    <p class="mycomment" id="${id}-nickname">${nickname} ì´(ê°€) ì”€.</p>
                    <p class="time">${modifiedAt}</p>
                    <i class="fa-solid fa-pen-field" onclick="modifying('${id}')">ìˆ˜ì •</i>
                    <i class="fa-regular fa-trash-can" onclick="deleting('${id}')">ì‚­ì œ</i>
                </div>
            </div>
        </div>`
            $('#diary-box').append(temp_html);
        }
        function save_diary() {
            let title = $('#title').val();
            let username = genRandomName(10);
            let contents = $('#contents').val();
            let nickname = $('#nickname').val();
            let data = {'title':title, 'username': username, 'nickname': nickname, 'contents': contents};

            $.ajax({
                type: 'POST',
                url: '/api/diaries',
                contentType: "application/json",
                data: JSON.stringify(data),
                success: function (response) {
                    alert('ì˜¤ëŠ˜ì˜ ì¼ê¸°ì‘ì„± ë! ì½”ìì~');
                    window.location.reload();

                }
            });

        }

        function open_box() {
            $('#post-box').show()
        }

        function close_box() {
            $('#post-box').hide()
        }

    </script>
</head>

<body>
<div class="mytitle">
    <h1>ì˜¤ëŠ˜, ê°ì •, ê·¸ë¦¬ê³  ì¼ê¸°</h1>
    <div>
        <button onclick="location.href='/user/signup'")>íšŒì›ê°€ì…</button>
        <button onclick="location.href='/user/login'")>ë¡œê·¸ì¸</button>
    </div>
    <p><span th:text="${nickname}" id="nowname"></span>ë‹˜ ì–´ì„œì˜¤ì„¸ìš”!</p>
    <button onclick="open_box()">âœì¼ê¸° ì“°ê¸°</button>
</div>
<div class="mypost" id="post-box">

    <div class="mb-3">
        <span th:text="${nickname}"></span>
        <textarea class="form-control" id="title" rows="3" placeholder="ì¼ê¸°ì˜ ì œëª©ì€ ë­˜ë¡œ í• ê¹Œìš”?"></textarea>
        <textarea class="form-control" id="contents" rows="3" placeholder="ì˜¤ëŠ˜ì˜ ê°ì •ì„ ê¸€ë¡œ í‘œí˜„í•´ë³¼ê¹Œìš”?"></textarea>
    </div>
    <div class="d-grid gap-2 d-md-flex justify-content-md-center">
        <button class="btn btn-blue" type="button" onclick="save_diary()">ì¼ê¸° ì €ì¥</button>
        <button class="btn btn-light" type="button" onclick="close_box()">ì¼ê¸°ì¥ ë‹«ê¸°</button>
    </div>
</div>
<div class="wrap">
    <div id="diary-box" class="row row-cols-1 row-cols-md-4 g-4">

    </div>
</div>
</body>
</html>